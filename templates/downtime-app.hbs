<div class="downtime-tracker">
  {{!-- Header --}}
  <header class="downtime-header">
    <h1><i class="fas fa-moon"></i> {{localize "DOWNTIME.Title"}}</h1>
  </header>

  {{!-- Timeline --}}
  <div class="timeline-container">
    <div class="timeline-header">
      <span class="timeline-label"><i class="fas fa-stream"></i> {{localize "DOWNTIME.Timeline.Title"}}</span>
      {{#if isGM}}
        <div class="timeline-controls">
          <button type="button" class="journal-sync-btn" title="{{localize "DOWNTIME.Journal.SyncButton"}}">
            <i class="fas fa-book"></i> {{localize "DOWNTIME.Journal.Sync"}}
          </button>
          <button type="button" class="create-marker" title="{{localize "DOWNTIME.Markers.CreateNew"}}">
            <i class="fas fa-plus"></i> {{localize "DOWNTIME.Markers.NewMarker"}}
          </button>
        </div>
      {{/if}}
    </div>
    <div class="timeline-rail-wrapper">
      <div class="timeline-rail">
        <div class="timeline-line"></div>
        {{#each timelineMarkers}}
          <div class="timeline-node {{#if this.isActive}}active{{/if}} {{#unless this.downtimeAllowed}}disabled{{/unless}}"
               data-marker-id="{{this.id}}"
               {{#if ../isGM}}draggable="true"{{/if}}>
            <div class="node-dot"></div>
            <div class="node-label">{{this.title}}</div>
            {{#if ../isGM}}
              <div class="node-actions">
                <button type="button" class="edit-marker" data-marker-id="{{this.id}}" title="{{localize "DOWNTIME.Markers.Edit"}}">
                  <i class="fas fa-edit"></i>
                </button>
                <button type="button" class="delete-marker" data-marker-id="{{this.id}}" title="{{localize "DOWNTIME.Markers.Delete"}}">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            {{/if}}
          </div>
        {{else}}
          <div class="timeline-empty">{{localize "DOWNTIME.Timeline.NoMarkers"}}</div>
        {{/each}}
      </div>
    </div>
    {{#if activeMarker}}
      <div class="active-marker-detail {{#unless activeMarker.downtimeAllowed}}downtime-disabled{{/unless}}">
        <div class="marker-detail-row">
          <div class="marker-detail-info">
            <span class="detail-title"><i class="fas fa-bookmark"></i> {{activeMarker.title}}</span>
            {{#if activeMarker.description}}
              <span class="detail-description">{{activeMarker.description}}</span>
            {{/if}}
            {{#unless activeMarker.downtimeAllowed}}
              <span class="detail-status"><i class="fas fa-ban"></i> {{localize "DOWNTIME.Timeline.DowntimeNotAvailable"}}</span>
            {{/unless}}
            {{#if activeMarker.restrictions}}
              <span class="detail-restrictions"><i class="fas fa-exclamation-triangle"></i> {{activeMarker.restrictions}}</span>
            {{/if}}
          </div>
          {{#if assignedCharacters.length}}
            <div class="detail-assigned-characters">
              {{#each assignedCharacters}}
                <img src="{{this.img}}" alt="{{this.name}}" class="assigned-char-portrait" title="{{this.name}}"/>
              {{/each}}
            </div>
          {{/if}}
        </div>
        {{#if markerHistory.length}}
          <div class="marker-history-row">
            <span class="history-row-label"><i class="fas fa-history"></i> {{localize "DOWNTIME.MarkerHistory.Activity"}}</span>
            {{#each markerHistory}}
              <div class="marker-history-badge {{this.result.rollResult}}">
                <img src="{{this.characterImg}}" alt="{{this.characterName}}" class="badge-portrait" title="{{this.characterName}}"/>
                <span class="badge-action">{{this.actionName}}</span>
                {{#if this.result.rollResult}}
                  <span class="badge-result">{{this.result.rollResult}}</span>
                {{/if}}
              </div>
            {{/each}}
          </div>
        {{/if}}
      </div>
    {{/if}}
  </div>

  {{!-- Main Content --}}
  <div class="downtime-content">
    {{!-- Left Panel: Characters --}}
    <aside class="character-panel">
      <h2>{{localize "DOWNTIME.Characters.Title"}}</h2>
      <ul class="character-list">
        {{#each characters}}
          <li class="character-item {{#if this.selected}}selected{{/if}}"
              data-actor-id="{{this.id}}">
            <img src="{{this.img}}" alt="{{this.name}}" class="character-portrait"/>
            <span class="character-name">{{this.name}}</span>
          </li>
        {{else}}
          <li class="no-characters">{{localize "DOWNTIME.Characters.None"}}</li>
        {{/each}}
      </ul>
    </aside>

    {{!-- Center Panel: Actions --}}
    <main class="actions-panel">
      {{#if selectedCharacter}}
        <div class="selected-character-header">
          <img src="{{selectedCharacter.img}}" class="mini-portrait"/>
          <h2>{{selectedCharacter.name}}</h2>
        </div>

        {{!-- Category Filter --}}
        <div class="category-filter">
          <button type="button" class="filter-btn {{#unless filterCategory}}active{{/unless}}" data-category="all">
            All
          </button>
          {{#each categories}}
            <button type="button" class="filter-btn {{#if this.active}}active{{/if}}" data-category="{{this.id}}">
              {{this.name}}
            </button>
          {{/each}}
        </div>

        {{!-- Actions List --}}
        <div class="actions-list">
          {{#each actionSets}}
            <div class="action-set" data-set-id="{{this.id}}">
              <h3 class="action-set-header">{{this.name}}</h3>
              <div class="action-set-actions">
                {{#each this.actions}}
                  <div class="action-card" data-action-id="{{this.id}}">
                    <div class="action-header">
                      <h4 class="action-name">{{this.name}}</h4>
                      {{#if this.category}}
                        <span class="action-category">{{this.category}}</span>
                      {{/if}}
                    </div>
                    <p class="action-description">{{this.description}}</p>
                    <div class="action-footer">
                      {{#if this.requiresRoll}}
                        <span class="requires-roll"><i class="fas fa-dice"></i> Roll</span>
                      {{/if}}
                      <button type="button" class="execute-action" data-action-id="{{this.id}}">
                        Execute
                      </button>
                    </div>
                  </div>
                {{/each}}
              </div>
            </div>
          {{else}}
            <p class="no-actions">No actions available</p>
          {{/each}}
        </div>
      {{else}}
        <div class="no-selection">
          <p>Select a character to see available actions</p>
        </div>
      {{/if}}
    </main>

    {{!-- Right Panel: History --}}
    <aside class="history-panel">
      <h2>{{localize "DOWNTIME.History.Title"}}</h2>
      {{#if selectedCharacter}}
        {{#if characterHistory.length}}
          <ul class="history-list">
            {{#each characterHistory}}
              <li class="history-item">
                <span class="action-name">{{this.actionName}}</span>
                {{#if this.result.rollResult}}
                  <span class="result {{this.result.rollResult}}">{{this.result.rollResult}}</span>
                {{/if}}
                <span class="timestamp">{{this.timestamp}}</span>
              </li>
            {{/each}}
          </ul>
        {{else}}
          <p class="no-history">No actions recorded</p>
        {{/if}}
      {{else}}
        <p class="no-history">Select a character</p>
      {{/if}}
    </aside>
  </div>
</div>
