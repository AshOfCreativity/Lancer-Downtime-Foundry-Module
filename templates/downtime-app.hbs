<div class="downtime-tracker">
  {{!-- Header --}}
  <header class="downtime-header">
    <h1><i class="fas fa-moon"></i> {{localize "DOWNTIME.Title"}}</h1>
  </header>

  {{!-- Marker Bar --}}
  <div class="marker-bar">
    {{#if activeMarker}}
      <div class="active-marker {{#unless activeMarker.downtimeAllowed}}downtime-disabled{{/unless}}">
        <span class="marker-title"><i class="fas fa-bookmark"></i> {{activeMarker.title}}</span>
        {{#if activeMarker.description}}
          <span class="marker-description">{{activeMarker.description}}</span>
        {{/if}}
        {{#unless activeMarker.downtimeAllowed}}
          <span class="marker-status"><i class="fas fa-ban"></i> Downtime not available</span>
        {{/unless}}
        {{#if activeMarker.restrictions}}
          <span class="marker-restrictions"><i class="fas fa-exclamation-triangle"></i> {{activeMarker.restrictions}}</span>
        {{/if}}
      </div>
    {{else}}
      <div class="no-marker">
        <span>No active marker</span>
      </div>
    {{/if}}
    {{#if isGM}}
      <button type="button" class="create-marker" title="Create new marker">
        <i class="fas fa-plus"></i> New Marker
      </button>
    {{/if}}
  </div>

  {{!-- Main Content --}}
  <div class="downtime-content">
    {{!-- Left Panel: Characters --}}
    <aside class="character-panel">
      <h2>{{localize "DOWNTIME.Characters.Title"}}</h2>
      <ul class="character-list">
        {{#each characters}}
          <li class="character-item {{#if this.selected}}selected{{/if}}"
              data-actor-id="{{this.id}}">
            <img src="{{this.img}}" alt="{{this.name}}" class="character-portrait"/>
            <span class="character-name">{{this.name}}</span>
          </li>
        {{else}}
          <li class="no-characters">{{localize "DOWNTIME.Characters.None"}}</li>
        {{/each}}
      </ul>
    </aside>

    {{!-- Center Panel: Actions --}}
    <main class="actions-panel">
      {{#if selectedCharacter}}
        <div class="selected-character-header">
          <img src="{{selectedCharacter.img}}" class="mini-portrait"/>
          <h2>{{selectedCharacter.name}}</h2>
        </div>

        {{!-- Category Filter --}}
        <div class="category-filter">
          <button type="button" class="filter-btn {{#unless filterCategory}}active{{/unless}}" data-category="all">
            All
          </button>
          {{#each categories}}
            <button type="button" class="filter-btn {{#if this.active}}active{{/if}}" data-category="{{this.id}}">
              {{this.name}}
            </button>
          {{/each}}
        </div>

        {{!-- Actions List --}}
        <div class="actions-list">
          {{#each actionSets}}
            <div class="action-set" data-set-id="{{this.id}}">
              <h3 class="action-set-header">{{this.name}}</h3>
              <div class="action-set-actions">
                {{#each this.actions}}
                  <div class="action-card" data-action-id="{{this.id}}">
                    <div class="action-header">
                      <h4 class="action-name">{{this.name}}</h4>
                      {{#if this.category}}
                        <span class="action-category">{{this.category}}</span>
                      {{/if}}
                    </div>
                    <p class="action-description">{{this.description}}</p>
                    <div class="action-footer">
                      {{#if this.requiresRoll}}
                        <span class="requires-roll"><i class="fas fa-dice"></i> Roll</span>
                      {{/if}}
                      <button type="button" class="execute-action" data-action-id="{{this.id}}">
                        Execute
                      </button>
                    </div>
                  </div>
                {{/each}}
              </div>
            </div>
          {{else}}
            <p class="no-actions">No actions available</p>
          {{/each}}
        </div>
      {{else}}
        <div class="no-selection">
          <p>Select a character to see available actions</p>
        </div>
      {{/if}}
    </main>

    {{!-- Right Panel: History --}}
    <aside class="history-panel">
      <h2>{{localize "DOWNTIME.History.Title"}}</h2>
      {{#if selectedCharacter}}
        {{#if characterHistory.length}}
          <ul class="history-list">
            {{#each characterHistory}}
              <li class="history-item">
                <span class="action-name">{{this.actionName}}</span>
                {{#if this.result.rollResult}}
                  <span class="result {{this.result.rollResult}}">{{this.result.rollResult}}</span>
                {{/if}}
                <span class="timestamp">{{this.timestamp}}</span>
              </li>
            {{/each}}
          </ul>
        {{else}}
          <p class="no-history">No actions recorded</p>
        {{/if}}
      {{else}}
        <p class="no-history">Select a character</p>
      {{/if}}
    </aside>
  </div>
</div>
